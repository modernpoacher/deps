"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.getSaveBundleCommands=getSaveBundleCommands;exports.getSaveOptionalCommands=getSaveOptionalCommands;exports.getSaveDevCommands=getSaveDevCommands;exports.getSaveProdCommands=getSaveProdCommands;exports.installSaveBundleExact=installSaveBundleExact;exports.installSaveBundle=installSaveBundle;exports.installSaveOptionalExact=installSaveOptionalExact;exports.installSaveOptional=installSaveOptional;exports.installSaveDevExact=installSaveDevExact;exports.installSaveDev=installSaveDev;exports.installSaveProdExact=installSaveProdExact;exports.installSaveProd=installSaveProd;exports.executeBundle=executeBundle;exports.executeOptional=executeOptional;exports.executeDev=executeDev;exports.executeProd=executeProd;exports.getCommands=exports.shell=void 0;var _debug=_interopRequireDefault(require("debug"));var _child_process=require("child_process");var _common=require("./common");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}const log=(0,_debug.default)('@modernpoacher/deps');log('`deps` is awake');const shell=d=>`
#!/bin/sh

cd "${d}"

if [ -f ~/.nvm/nvm.sh ];
then
  . ~/.nvm/nvm.sh

  nvm use # VERSION=$(nvm --version)
elif command -v brew;
then # https://docs.brew.sh/Manpage#--prefix-formula
  BREW_PREFIX=$(brew --prefix nvm)
  if [ -f "$BREW_PREFIX/nvm.sh" ];
  then
    . $BREW_PREFIX/nvm.sh

    nvm use # VERSION=$(nvm --version)
  fi
fi
`;exports.shell=shell;const getCommands=(p,c,r,e)=>['npm','i'].concat((0,_common.transform)(p,c)).concat(r?['--registry',r]:[]).concat(e?'--save-exact':[]);exports.getCommands=getCommands;function getSaveBundleCommands(p,c,r,e=false){log('getSaveBundleCommands');return getCommands(p,c,r,e).concat('--save-bundle');}function getSaveOptionalCommands(p,c,r,e=false){log('getSaveOptionalCommands');return getCommands(p,c,r,e).concat('--save-optional');}function getSaveDevCommands(p,c,r,e=false){log('getSaveDevCommands');return getCommands(p,c,r,e).concat('--save-dev');}function getSaveProdCommands(p,c,r,e=false){log('getSaveProdCommands');return getCommands(p,c,r,e).concat('--save-prod');}function installSaveBundleExact(d,p,c,r){log('installSaveBundleExact');return new Promise((resolve,reject)=>{const commands=getSaveBundleCommands(p,c,r,true);(0,_child_process.spawn)(shell(d),commands,{shell:true,stdio:'inherit'},e=>!e?resolve():reject(e)).on('close',resolve).on('error',reject);});}function installSaveBundle(d,p,c,r){log('installSaveBundle');return new Promise((resolve,reject)=>{const commands=getSaveBundleCommands(p,c,r);(0,_child_process.spawn)(shell(d),commands,{shell:true,stdio:'inherit'},e=>!e?resolve():reject(e)).on('close',resolve).on('error',reject);});}function installSaveOptionalExact(d,p,c,r){log('installSaveOptionalExact');return new Promise((resolve,reject)=>{const commands=getSaveOptionalCommands(p,c,r,true);(0,_child_process.spawn)(shell(d),commands,{shell:true,stdio:'inherit'},e=>!e?resolve():reject(e)).on('close',resolve).on('error',reject);});}function installSaveOptional(d,p,c,r){log('installSaveOptional');return new Promise((resolve,reject)=>{const commands=getSaveOptionalCommands(p,c,r);(0,_child_process.spawn)(shell(d),commands,{shell:true,stdio:'inherit'},e=>!e?resolve():reject(e)).on('close',resolve).on('error',reject);});}function installSaveDevExact(d,p,c,r){log('installSaveDevExact');return new Promise((resolve,reject)=>{const commands=getSaveDevCommands(p,c,r,true);log(shell(d));log(commands.join(' '));(0,_child_process.spawn)(shell(d),commands,{shell:true,stdio:'inherit'},e=>!e?resolve():reject(e)).on('close',resolve).on('error',reject);});}function installSaveDev(d,p,c,r){log('installSaveDev');return new Promise((resolve,reject)=>{const commands=getSaveDevCommands(p,c,r);log(shell(d));log(commands.join(' '));(0,_child_process.spawn)(shell(d),commands,{shell:true,stdio:'inherit'},e=>!e?resolve():reject(e)).on('close',resolve).on('error',reject);});}function installSaveProdExact(d,p,c,r){log('installSaveProdExact');return new Promise((resolve,reject)=>{const commands=getSaveProdCommands(p,c,r,true);log(shell(d));log(commands.join(' '));(0,_child_process.spawn)(shell(d),commands,{shell:true,stdio:'inherit'},e=>!e?resolve():reject(e)).on('close',resolve).on('error',reject);});}function installSaveProd(d,p,c,r){log('installSaveProd');return new Promise((resolve,reject)=>{const commands=getSaveProdCommands(p,c,r);log(shell(d));log(commands.join(' '));(0,_child_process.spawn)(shell(d),commands,{shell:true,stdio:'inherit'},e=>!e?resolve():reject(e)).on('close',resolve).on('error',reject);});}async function executeBundle(directory='.',packages={},configuration={},registry='https://registry.npmjs.org'){log('executeBundle');const depsExact=(0,_common.getDepsExact)(packages,configuration);if(depsExact.length)await installSaveBundleExact(directory,depsExact,configuration,registry);const deps=(0,_common.getDeps)(packages);if(deps.length)await installSaveBundle(directory,deps,configuration,registry);}async function executeOptional(directory='.',packages={},configuration={},registry='https://registry.npmjs.org'){log('executeOptional');const depsExact=(0,_common.getDepsExact)(packages,configuration);if(depsExact.length)await installSaveOptionalExact(directory,depsExact,configuration,registry);const deps=(0,_common.getDeps)(packages);if(deps.length)await installSaveOptional(directory,deps,configuration,registry);}async function executeDev(directory='.',packages={},configuration={},registry='https://registry.npmjs.org'){log('executeDev');const depsExact=(0,_common.getDepsExact)(packages,configuration);if(depsExact.length)await installSaveDevExact(directory,depsExact,configuration,registry);const deps=(0,_common.getDeps)(packages);if(deps.length)await installSaveDev(directory,deps,configuration,registry);}async function executeProd(directory='.',packages={},configuration={},registry='https://registry.npmjs.org'){log('executeProd');const depsExact=(0,_common.getDepsExact)(packages,configuration);if(depsExact.length)await installSaveProdExact(directory,depsExact,configuration,registry);const deps=(0,_common.getDeps)(packages);if(deps.length)await installSaveProd(directory,deps,configuration,registry);}